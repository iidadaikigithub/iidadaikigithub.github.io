<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>てんすうシステム</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 20px; /* 文字全体を少し大きく */
    }

    .container {
      display: flex;
      justify-content: space-around;
      width: 100%;
      max-width: 800px;
    }

    .party {
      flex: 1;
      margin: 10px;
      text-align: center;
      transition: transform 0.3s;
    }

    .party img {
      width: 100%;
      max-width: 200px;
      cursor: pointer;
    }

    .bar-container {
      height: 300px;
      background: #eee;
      margin: 10px 0;
      position: relative;
    }

    .bar {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: #4CAF50;
      transition: height 0.3s;
    }

    .votes {
      font-size: 180px;
      font-weight: bold;
    }

    button {
      margin-top: 20px;
      font-size: 20px;
      padding: 12px 24px;
    }

    .party-name {
      font-size: 24px;
      margin-top: 10px;
    }

    /* 勝った瞬間だけ揺らす */
    .sway-once {
      animation: sway 0.6s ease-in-out 1;
    }

    @keyframes sway {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(-2deg); }
      50% { transform: rotate(2deg); }
      75% { transform: rotate(-1deg); }
      100% { transform: rotate(0deg); }
    }

    /* 光る効果（常に表示） */
    .glow {
      box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0.7);
    }
  </style>
</head>
<body>

  <h1></h1>

  <div class="container">
    <div class="party" id="ao">
      <img src="ao.jpg" alt="青チーム" onclick="vote('ao')">
      <div class="party-name">青チーム</div>
      <div class="bar-container">
        <div class="bar" id="bar-ao" style="height: 0%; background: #3498db;"></div>
      </div>
      <div class="votes" id="votes-ao">0 点</div>
    </div>

    <div class="party" id="aka">
      <img src="aka.jpg" alt="赤チーム" onclick="vote('aka')">
      <div class="party-name">赤チーム</div>
      <div class="bar-container">
        <div class="bar" id="bar-aka" style="height: 0%; background: #e74c3c;"></div>
      </div>
      <div class="votes" id="votes-aka">0 点</div>
    </div>
  </div>

  <button onclick="undo()">ひとつ戻る</button>

  <!-- MP3ファイルを複数用意 -->
  <audio id="ao1" src="AO1.MP3" preload="auto"></audio>
  <audio id="aopass" src="AOPASS.MP3" preload="auto"></audio>
  <audio id="aka1" src="AKA1.MP3" preload="auto"></audio>
  <audio id="akapass" src="AKAPASS.MP3" preload="auto"></audio>

  <script>
    const votes = { ao: 0, aka: 0 };
    const history = [];
    let previousWinner = null;

    // 画像要素取得
    const aoImg = document.querySelector('#ao img');
    const akaImg = document.querySelector('#aka img');

    // 加点連打防止フラグ
    let canAdd = true;
    // 画面全体でクリックを受け付ける
    document.body.addEventListener('mousedown', function(e) {
      let party = null;
      // 左クリック
      if (e.button === 0) {
        if (e.target === aoImg) party = 'ao';
        else if (e.target === akaImg) party = 'aka';
        else party = 'ao';
      }
      // ミドルクリック（button=1）
      if (e.button === 1) {
        if (e.target === akaImg) party = 'aka';
        else party = 'aka';
        e.preventDefault(); // ブラウザ機能禁止
      }
      // 右クリック（button=2）
      if (e.button === 2) {
        if (e.target === akaImg) party = 'aka';
        else party = 'aka';
        e.preventDefault(); // ブラウザ機能禁止
      }
      // 戻る・進むボタン（button=3,4）は禁止
      if (e.button === 3 || e.button === 4) {
        e.preventDefault();
        return;
      }
      if (party && canAdd) {
        handleVote(party, e);
        canAdd = false;
        setTimeout(() => { canAdd = true; }, 5000);
      }
    });
    // 音再生の許可（初回クリックでフラグのみセット）
    let audioUnlocked = false;
    function unlockAudio() {
      audioUnlocked = true;
    }
    document.body.addEventListener('mousedown', unlockAudio, { once: true });
    // ALT→でAOPASS.MP3再生・得点追加（5秒間隔のみ）
    document.addEventListener('keydown', function(e) {
      if (e.altKey && e.key === 'ArrowRight') {
        if (canAdd) {
          handleVote('ao', {button:99});
        }
        e.preventDefault();
        return;
      }
      // ...existing code...

    // 右クリック禁止
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // 得点処理（左・ミドル・右クリック/ALT→）
    function handleVote(party, e) {
      if (!canAdd) return;
      let audioId = '';
      if (e.button === 0) audioId = 'ao1'; // 左クリック
      else if (e.button === 1) audioId = 'aka1'; // ミドルクリック
      else if (e.button === 2) audioId = 'akapass'; // 右クリック
      else if (e.button === 99) audioId = 'aopass'; // ALT→
      if (party === 'undou' || party === 'karaoke') {
        votes[party]++;
        history.push(party);
        if (audioId) {
          const audio = document.getElementById(audioId);
          audio.currentTime = 0;
          if (!audioUnlocked) {
            audio.play().catch(()=>{});
            audioUnlocked = true;
          } else {
            audio.play();
          }
        }
        updateDisplay();
        canAdd = false;
        setTimeout(() => { canAdd = true; }, 5000);
      }
    }

    function undo() {
      const lastVote = history.pop();
      if (lastVote && votes[lastVote] > 0) {
        votes[lastVote]--;
        updateDisplay();
      }
    }

    function updateDisplay() {
      const total = votes.ao + votes.aka || 1;
      const percentAo = (votes.ao / total) * 100;
      const percentAka = (votes.aka / total) * 100;
      document.getElementById('votes-ao').textContent = `${votes.ao} 点`;
      document.getElementById('votes-aka').textContent = `${votes.aka} 点`;
      document.getElementById('bar-ao').style.height = percentAo + '%';
      document.getElementById('bar-aka').style.height = percentAka + '%';
      const aoEl = document.getElementById('ao');
      const akaEl = document.getElementById('aka');
      aoEl.classList.remove('glow', 'sway-once');
      akaEl.classList.remove('glow', 'sway-once');
      let currentWinner = null;
      if (votes.ao > votes.aka) currentWinner = 'ao';
      else if (votes.aka > votes.ao) currentWinner = 'aka';
      if (currentWinner) {
        const winnerEl = document.getElementById(currentWinner);
        winnerEl.classList.add('glow');
        if (currentWinner !== previousWinner) {
          winnerEl.classList.add('sway-once');
          setTimeout(() => {
            winnerEl.classList.remove('sway-once');
          }, 700);
        }
      }
      previousWinner = currentWinner;
    }
    // 初期表示
    updateDisplay();
  </script>

</body>
</html>
