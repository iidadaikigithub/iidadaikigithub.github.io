<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>さかなとりゲーム</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      position: relative;
    }
    #background-layers {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
    }
    #background-layers img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
    }
    #layer1 { z-index: 1; }
    #layer2 { z-index: 2; }
    #suisouwaku { z-index: 3; }
    #suisou     { z-index: 4; }
    #suisou2    { z-index: 5; }
    #sakana-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: auto;
      z-index: 100;
    }
    #sakana-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: auto;
      z-index: 10;
    }
    #caught-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: auto;
      z-index: 11;
    }
    .sakana {
      position: absolute;
      pointer-events: auto;
      cursor: pointer;
    }
    .caught {
      position: absolute;
    }
  </style>
</head>
<body>
  <div id="background-layers">
    <img src="haikei.png" id="layer1">
    <img src="haikei2.png" id="layer2">
    <img src="suisouwaku.png" id="suisouwaku" style="right:0;bottom:0;width:200px;height:auto;">
    <img src="suisou.png" id="suisou" style="right:0;bottom:0;width:200px;height:auto;">
    <img src="suisou2.png" id="suisou2" style="right:0;bottom:0;width:200px;height:auto;">
  </div>
  <div id="sakana-layer"></div>
  <div id="sakana-container"></div>
  <div id="caught-container"></div>
  <!-- アミ選択UI -->
  <div id="ami-icons" style="position:fixed;top:2%;right:10%;z-index:210;display:flex;flex-direction:column;gap:1em;">
    <img src="ami1.png" id="ami1-icon" style="width:180px;height:180px;cursor:pointer;border:2px solid #ccc;background:#fff;border-radius:50%;">
    <img src="ami2.png" id="ami2-icon" style="width:360px;height:360px;cursor:pointer;border:2px solid #ccc;background:#fff;border-radius:50%;">
    <button id="reset-cursor-btn" style="width:120px;height:60px;font-size:1.2rem;cursor:pointer;margin-top:1em;align-self:center;">クリックに戻す</button>
  </div>
  <button id="show-count-btn" style="position:fixed;top:2%;right:2%;font-size:1.5rem;padding:0.5em 1.5em;z-index:200;">集計</button>
  <div id="count-modal" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;padding:1em 2em;z-index:300;display:none;background:rgba(255,255,255,0.95);border-radius:1em;box-shadow:0 0 20px #888;">0匹</div>
  <script>
    // アミ選択・ポインタ制御
    let currentAmi = null;
    let customCursor = null;
    const amiIcons = [
      { id: 'ami1-icon', src: 'ami1.png', size: 180 }, // 3倍
      { id: 'ami2-icon', src: 'ami2.png', size: 360 }  // 6倍
    ];
    amiIcons.forEach(({id,src,size}) => {
      document.getElementById(id).addEventListener('click', () => {
        if (currentAmi === src) {
          unsetAmiCursor();
        } else {
          setAmiCursor(src, size);
        }
      });
    });
    // クリックに戻すボタン
    document.getElementById('reset-cursor-btn').addEventListener('click', unsetAmiCursor);
    function setAmiCursor(src, size) {
      unsetAmiCursor();
      currentAmi = src;
      // カスタムカーソル画像をbodyに追従
      customCursor = document.createElement('img');
      customCursor.src = src;
      customCursor.style.position = 'fixed';
      customCursor.style.pointerEvents = 'none';
      customCursor.style.zIndex = 9999;
      customCursor.style.width = customCursor.style.height = size+'px';
      customCursor.style.opacity = 0.85;
      document.body.appendChild(customCursor);
      document.body.style.cursor = 'none';
      window.addEventListener('pointermove', moveCustomCursor);
    }
    function unsetAmiCursor() {
      currentAmi = null;
      if (customCursor) {
        customCursor.remove();
        customCursor = null;
      }
      document.body.style.cursor = '';
      window.removeEventListener('pointermove', moveCustomCursor);
    }
    function moveCustomCursor(e) {
      if (customCursor) {
        customCursor.style.left = (e.clientX - customCursor.width/2) + 'px';
        customCursor.style.top = (e.clientY - customCursor.height/2) + 'px';
      }
    }
    // アミで魚を捕まえる
    window.addEventListener('pointerdown', function(e) {
      if (!currentAmi) return;
      // カーソル座標とアミ画像サイズで矩形を作る
      const cx = e.clientX, cy = e.clientY;
      const r = (customCursor ? customCursor.width/2 : 40);
      // .sakanaのうち、アミ範囲に重なるものを全て捕獲
      document.querySelectorAll('.sakana').forEach(sakana => {
        const rect = sakana.getBoundingClientRect();
        // 矩形中心同士の距離で判定（簡易円形ヒット）
        const sx = rect.left + rect.width/2;
        const sy = rect.top + rect.height/2;
        const dist = Math.hypot(cx-sx, cy-sy);
        if (dist < Math.max(r,rect.width/2,rect.height/2)) {
          catchSakana(sakana);
        }
      });
      // 通常のクリックイベントは止める
      e.preventDefault();
    }, true);
    const sakanaContainer = document.getElementById('sakana-container');
    const caughtContainer = document.getElementById('caught-container');
    const sakanaImages = ['sakana.gif', 'sakana2.gif'];

    let sakanaCount = 0;
    function createSakana() {
      // 50匹まで
      if (sakanaCount >= 50) return;
      sakanaCount++;
      const img = document.createElement('img');
      img.src = sakanaImages[Math.floor(Math.random() * sakanaImages.length)];
      img.classList.add('sakana');
      img.style.width = `${30 + Math.random() * 70}px`;
      img.style.top = `${Math.random() * window.innerHeight * 0.8}px`;
      let x = Math.random() * window.innerWidth;
      let direction = Math.random() < 0.5 ? 1 : -1;
      let speed = 1 + Math.random() * 2;
      img.style.left = `${x}px`;

      // レイヤーをランダムで決定
      const sakanaLayer = document.getElementById('sakana-layer');
  // どちらのレイヤーでも一番前に
  img.style.zIndex = 100;
  sakanaLayer.appendChild(img);
  // イベントリスナーはappendChild後に必ず再設定
  img.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    if (!img.classList.contains('caught')) {
      catchSakana(img);
    }
  });

      function setFishDirection(dir) {
        // 右向きなら反転、左向きならそのまま
        img.style.transform = dir === 1 ? 'scaleX(-1)' : '';
      }
      setFishDirection(direction);
      function move() {
        x += direction * speed;
        img.style.left = `${x}px`;
        // 端で反転
        if (x < -100) {
          direction = 1;
          setFishDirection(direction);
        }
        if (x > window.innerWidth + 100) {
          direction = -1;
          setFishDirection(direction);
        }
        if (x < -100 || x > window.innerWidth + 100) {
          img.remove();
          sakanaCount--;
        } else {
          requestAnimationFrame(move);
        }
      }
      move();

      // ここは不要（appendChild後に設定済み）
    }

    // 集計ボタンとモーダル
    const showCountBtn = document.getElementById('show-count-btn');
    const countModal = document.getElementById('count-modal');
    showCountBtn.addEventListener('click', () => {
      // 水槽内の魚（.caught）の数をカウント
      const count = document.querySelectorAll('.caught').length;
      countModal.textContent = `${count}匹`;
      countModal.style.display = 'block';
      setTimeout(() => { countModal.style.display = 'none'; }, 1500);
    });
    function catchSakana(sakana) {
      // すでに捕獲済みなら何もしない
      if (sakana.classList.contains('caught')) return;
      // 一瞬大きくして元に戻すアニメーション
      sakana.style.transition = 'transform 0.2s';
      sakana.style.transform = 'scale(1.7)';
      setTimeout(() => {
        sakana.style.transform = 'scale(1)';
        setTimeout(() => {
          sakana.remove();
          sakanaCount--;
          const newSakana = sakana.cloneNode(true);
          newSakana.classList.remove('sakana');
          newSakana.classList.add('caught');
          newSakana.style.transition = '';
          newSakana.style.transform = '';
          // z-indexを一番前に
          newSakana.style.zIndex = 100;
          // #sakana-layer内に追加
          document.getElementById('sakana-layer').appendChild(newSakana);
          animateCaught(newSakana);
        }, 200);
      }, 200);
    }

    function animateCaught(sakana) {
      const tank = document.getElementById('suisou');
      const tankRect = tank.getBoundingClientRect();
      const bodyRect = document.body.getBoundingClientRect();
      const tankLeft = tankRect.left - bodyRect.left;
      const tankTop = tankRect.top - bodyRect.top;
      const tankWidth = tank.offsetWidth;
      const tankHeight = tank.offsetHeight;

      // 水槽内の初期位置・サイズ
      let fishW = 40 + Math.random() * 30;
      let fishH = fishW * 0.5;
      let x = tankLeft + Math.random() * (tankWidth - fishW);
      let y = tankTop + Math.random() * (tankHeight - fishH);
      sakana.style.position = 'absolute';
      sakana.style.left = `${x}px`;
      sakana.style.top = `${y}px`;
      sakana.style.width = `${fishW}px`;
      sakana.style.height = `${fishH}px`;
      sakana.style.transition = '';
      sakana.style.transform = '';

      // 進行方向（右向きなら1, 左向きなら-1）
      let direction = Math.random() < 0.5 ? 1 : -1;
      let dx = direction * (1 + Math.random() * 1.5);
      let dy = (Math.random() - 0.5) * 1.2;

      // 反転用
      function setFishDirection(dir) {
        // 右向きなら反転、左向きならそのまま
        sakana.style.transform = dir === 1 ? 'scaleX(-1)' : '';
      }
      setFishDirection(direction);

      function swim() {
        x += dx;
        y += dy;
        // 上下端で跳ね返り
        if (y < tankTop) { y = tankTop; dy *= -1; }
        if (y > tankTop + tankHeight - fishH) { y = tankTop + tankHeight - fishH; dy *= -1; }
        // 左右端で反転
        if (x < tankLeft) {
          x = tankLeft;
          dx = Math.abs(dx);
          direction = 1;
          setFishDirection(direction);
        }
        if (x > tankLeft + tankWidth - fishW) {
          x = tankLeft + tankWidth - fishW;
          dx = -Math.abs(dx);
          direction = -1;
          setFishDirection(direction);
        }
        sakana.style.left = `${x}px`;
        sakana.style.top = `${y}px`;
        requestAnimationFrame(swim);
      }
      swim();
    }

    // 魚を定期的に追加
    setInterval(createSakana, 1000);
  </script>
</body>
</html>
