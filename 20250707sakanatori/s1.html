<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>さかなとりゲーム</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      position: relative;
    }
    #background-layers {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
    }
    #background-layers img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
    }
    #layer1 { z-index: 1; }
    #layer2 { z-index: 2; }
    #suisouwaku { z-index: 3; }
    #suisou     { z-index: 4; }
    #suisou2    { z-index: 5; }
    #sakana-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: auto;
      z-index: 100;
    }
    #sakana-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: auto;
      z-index: 10;
    }
    #caught-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: auto;
      z-index: 11;
    }
    .sakana {
      position: absolute;
      pointer-events: auto;
      cursor: pointer;
    }
    .caught {
      position: absolute;
    }
  </style>
</head>
<body>
  <div id="background-layers">
    <img src="haikei.png" id="layer1">
    <!-- <img src="haikei2.png" id="layer2"> -->
    <!-- <img src="suisouwaku.png" id="suisouwaku" style="right:0;bottom:0;width:200px;height:auto;"> -->
    <img src="suisou.png" id="suisou" style="right:0;bottom:0;width:200px;height:auto;">
    <img src="suisou2.png" id="suisou2" style="right:0;bottom:0;width:200px;height:auto;">
  </div>
  <div id="sakana-layer"></div>
  <div id="sakana-container"></div>
  <div id="caught-container"></div>
  <!-- アミ選択UI -->
  <div id="ami-icons" style="position:fixed;top:calc(2% + 3.5em);right:2%;z-index:210;display:flex;flex-direction:column;gap:1em;align-items:flex-end;">
    <img src="ami1.png" id="ami1-icon" style="width:60px;height:60px;cursor:pointer;border:2px solid #ccc;background:#fff;border-radius:50%;">
    <img src="ami2.png" id="ami2-icon" style="width:60px;height:60px;cursor:pointer;border:2px solid #ccc;background:#fff;border-radius:50%;">
    <button id="reset-cursor-btn" style="width:120px;height:60px;font-size:1.2rem;cursor:pointer;margin-top:1em;align-self:center;">クリックに戻す</button>
  </div>
  <button id="show-count-btn" style="position:fixed;top:2%;right:2%;font-size:1.5rem;padding:0.5em 1.5em;z-index:200;">集計</button>
  <div id="count-modal" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;padding:1em 2em;z-index:300;display:none;background:rgba(255,255,255,0.95);border-radius:1em;box-shadow:0 0 20px #888;">0匹</div>
  <script>
    // アミ選択・ポインタ制御
    let currentAmi = null;
    let customCursor = null;
    const amiIcons = [
      { id: 'ami1-icon', src: 'ami1.png', size: 180 }, // 3倍
      { id: 'ami2-icon', src: 'ami2.png', size: 360 }  // 6倍
    ]; // 選択アイコンは小さいまま、カーソルは大きい
    amiIcons.forEach(({id,src,size}) => {
      document.getElementById(id).addEventListener('click', () => {
        if (currentAmi === src) {
          unsetAmiCursor();
        } else {
          setAmiCursor(src, size, id);
        }
      });
    });
    // クリックに戻すボタン
    document.getElementById('reset-cursor-btn').addEventListener('click', unsetAmiCursor);
    function setAmiCursor(src, size, iconId) {
      unsetAmiCursor();
      currentAmi = src;
      // カスタムカーソル画像をbodyに追従
      customCursor = document.createElement('img');
      customCursor.src = src;
      customCursor.style.position = 'fixed';
      customCursor.style.pointerEvents = 'none';
      customCursor.style.zIndex = 9999;
      customCursor.style.width = customCursor.style.height = size+'px';
      customCursor.style.opacity = 0.85;
      document.body.appendChild(customCursor);
      document.body.style.cursor = 'none';
      window.addEventListener('pointermove', moveCustomCursor);
      // 使用感: クリック時にアミ画像を拡大アニメ
      window._amiCursorClickHandler = function() {
        if (!customCursor) return;
        customCursor.style.transition = 'transform 0.12s';
        customCursor.style.transform = 'scale(1.25)';
        setTimeout(() => {
          if (customCursor) {
            customCursor.style.transform = 'scale(1)';
            setTimeout(()=>{
              if(customCursor) customCursor.style.transition = '';
            }, 120);
          }
        }, 80);
      };
      window.addEventListener('pointerdown', window._amiCursorClickHandler);
    }
    function unsetAmiCursor() {
      currentAmi = null;
      if (customCursor) {
        customCursor.remove();
        customCursor = null;
      }
      document.body.style.cursor = '';
      window.removeEventListener('pointermove', moveCustomCursor);
      if (window._amiCursorClickHandler) {
        window.removeEventListener('pointerdown', window._amiCursorClickHandler);
        window._amiCursorClickHandler = null;
      }
    }
    function moveCustomCursor(e) {
      if (customCursor) {
        customCursor.style.left = (e.clientX - customCursor.width/2) + 'px';
        customCursor.style.top = (e.clientY - customCursor.height/2) + 'px';
      }
    }
    // アミで魚を捕まえる
    window.addEventListener('pointerdown', function(e) {
      if (!currentAmi) return;
      // カーソル座標とアミ画像サイズで矩形を作る
      const cx = e.clientX, cy = e.clientY;
      const r = (customCursor ? customCursor.width/2 : 40);
      // .sakanaのうち、アミ範囲に重なるものを全て捕獲
      document.querySelectorAll('.sakana').forEach(sakana => {
        const rect = sakana.getBoundingClientRect();
        // 矩形中心同士の距離で判定（簡易円形ヒット）
        const sx = rect.left + rect.width/2;
        const sy = rect.top + rect.height/2;
        const dist = Math.hypot(cx-sx, cy-sy);
        if (dist < Math.max(r,rect.width/2,rect.height/2)) {
          catchSakana(sakana);
        }
      });
      // 通常のクリックイベントは止める
      e.preventDefault();
    }, true);
    const sakanaContainer = document.getElementById('sakana-container');
    const caughtContainer = document.getElementById('caught-container');
    const sakanaImages = ['sakana.gif', 'sakana2.gif'];

    let sakanaCount = 0;
    function createSakana() {
      // 50匹まで
      if (sakanaCount >= 50) return;
      sakanaCount++;
      const img = document.createElement('img');
      img.src = sakanaImages[Math.floor(Math.random() * sakanaImages.length)];
      img.classList.add('sakana');
      // --- 魚の大きさバリエーション（8段階・中～大多め） ---
      // 8段階: 20-35, 36-50, 51-65, 66-80, 81-100, 101-120, 121-145, 146-180
      // 中～大多め: 3,4,5,6段階目の確率を高く
      const sizeRand = Math.random();
      let fishW;
      if (sizeRand < 0.05) {
        fishW = 20 + Math.random() * 15; // 1:極小
      } else if (sizeRand < 0.13) {
        fishW = 36 + Math.random() * 14; // 2:小
      } else if (sizeRand < 0.28) {
        fishW = 51 + Math.random() * 14; // 3:中小
      } else if (sizeRand < 0.48) {
        fishW = 66 + Math.random() * 14; // 4:中
      } else if (sizeRand < 0.73) {
        fishW = 81 + Math.random() * 19; // 5:中大
      } else if (sizeRand < 0.90) {
        fishW = 101 + Math.random() * 19; // 6:大
      } else if (sizeRand < 0.98) {
        fishW = 121 + Math.random() * 24; // 7:特大
      } else {
        fishW = 146 + Math.random() * 34; // 8:超特大
      }
      img.style.width = `${fishW}px`;
      img.style.top = `${Math.random() * window.innerHeight * 0.8}px`;
      let x = Math.random() * window.innerWidth;
      let direction = Math.random() < 0.5 ? 1 : -1;
      let speed = 1 + Math.random() * 2;
      img.style.left = `${x}px`;

      // --- 魚の色バリエーション ---
      // CSSフィルターで色を自動変化
      // 色相を0-360度でランダム
      const hue = Math.floor(Math.random() * 360);
      img.style.filter = `hue-rotate(${hue}deg)`;

      // レイヤーをランダムで決定
      const sakanaLayer = document.getElementById('sakana-layer');
      img.style.zIndex = 100;
      sakanaLayer.appendChild(img);
      // イベントリスナーはappendChild後に必ず再設定
      img.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        // 1回しか反応しないように
        if (!img.classList.contains('caught') && !img.classList.contains('catching')) {
          img.classList.add('catching');
          catchSakana(img);
        }
      });

      function setFishDirection(dir) {
        // 右向きなら反転、左向きならそのまま
        img.style.transform = dir === 1 ? 'scaleX(-1)' : '';
      }
      setFishDirection(direction);
      function move() {
        x += direction * speed;
        img.style.left = `${x}px`;
        // 端で反転
        if (x < -100) {
          direction = 1;
          setFishDirection(direction);
        }
        if (x > window.innerWidth + 100) {
          direction = -1;
          setFishDirection(direction);
        }
        if (x < -100 || x > window.innerWidth + 100) {
          img.remove();
          sakanaCount--;
        } else {
          requestAnimationFrame(move);
        }
      }
      move();
    }

    // 集計ボタンとモーダル
    const showCountBtn = document.getElementById('show-count-btn');
    const countModal = document.getElementById('count-modal');
    showCountBtn.addEventListener('click', () => {
      // 水槽内の魚（.caught）の数をカウント
      const count = document.querySelectorAll('.caught').length;
      countModal.textContent = `${count}匹`;
      countModal.style.display = 'block';
      setTimeout(() => { countModal.style.display = 'none'; }, 1500);
    });
    function catchSakana(sakana) {
      // すでに捕獲済み・捕獲中なら何もしない
      if (sakana.classList.contains('caught') || sakana.classList.contains('catching')) return;
      sakana.classList.add('catching');
      // 一瞬大きくして元に戻すアニメーション
      sakana.style.transition = 'transform 0.2s';
      sakana.style.transform = 'scale(1.7)';
      setTimeout(() => {
        sakana.style.transform = 'scale(1)';
        setTimeout(() => {
          sakana.remove();
          sakanaCount--;
          const newSakana = sakana.cloneNode(true);
          newSakana.classList.remove('sakana');
          newSakana.classList.remove('catching');
          newSakana.classList.add('caught');
          newSakana.style.transition = '';
          newSakana.style.transform = '';
          // z-indexを一番前に
          newSakana.style.zIndex = 100;
          // #sakana-layer内に追加
          document.getElementById('sakana-layer').appendChild(newSakana);
          animateCaught(newSakana);
        }, 200);
      }, 200);
    }

    function animateCaught(sakana) {
      const tank = document.getElementById('suisou');
      const tankRect = tank.getBoundingClientRect();
      const bodyRect = document.body.getBoundingClientRect();
      const tankLeft = tankRect.left - bodyRect.left;
      const tankTop = tankRect.top - bodyRect.top;
      const tankWidth = tank.offsetWidth;
      const tankHeight = tank.offsetHeight;

      // 水槽内の初期位置・サイズ
      let fishW = 40 + Math.random() * 30;
      let fishH = fishW * 0.5;
      // 水槽の上下2割を除いた中心付近のみ
      const yMin = tankTop + tankHeight * 0.2;
      const yMax = tankTop + tankHeight * 0.8 - fishH;
      let x = tankLeft + Math.random() * (tankWidth - fishW);
      let y = yMin + Math.random() * (yMax - yMin);
      sakana.style.position = 'absolute';
      sakana.style.left = `${x}px`;
      sakana.style.top = `${y}px`;
      sakana.style.width = `${fishW}px`;
      sakana.style.height = `${fishH}px`;
      sakana.style.transition = '';
      sakana.style.transform = '';

      // 進行方向（右向きなら1, 左向きなら-1）
      let direction = Math.random() < 0.5 ? 1 : -1;
      let dx = direction * (1 + Math.random() * 1.5);
      let dy = (Math.random() - 0.5) * 1.2;

      // 反転用
      function setFishDirection(dir) {
        // 右向きなら反転、左向きならそのまま
        sakana.style.transform = dir === 1 ? 'scaleX(-1)' : '';
      }
      setFishDirection(direction);

      function swim() {
        x += dx;
        y += dy;
        // 上下端で跳ね返り（中心付近のみ）
        if (y < yMin) { y = yMin; dy *= -1; }
        if (y > yMax) { y = yMax; dy *= -1; }
        // 左右端で反転
        if (x < tankLeft) {
          x = tankLeft;
          dx = Math.abs(dx);
          direction = 1;
          setFishDirection(direction);
        }
        if (x > tankLeft + tankWidth - fishW) {
          x = tankLeft + tankWidth - fishW;
          dx = -Math.abs(dx);
          direction = -1;
          setFishDirection(direction);
        }
        sakana.style.left = `${x}px`;
        sakana.style.top = `${y}px`;
        requestAnimationFrame(swim);
      }
      swim();
    }

    // 常に8匹以上になるように補充
    function ensureSakanaMin() {
      let now = document.querySelectorAll('.sakana').length;
      for (let i = now; i < 8; i++) {
        createSakana();
      }
    }
    setInterval(() => {
      ensureSakanaMin();
      createSakana(); // 既存のペースも維持
    }, 1000);
  </script>
</body>
</html>
