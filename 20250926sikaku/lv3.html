<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>しかくカウント lv3</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#f0f0f0; }
    #container { position:relative; width:100vw; height:100vh; }
    .sikaku {
      position:absolute; width:64px; height:64px; transition:transform 0.15s; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      box-sizing: border-box;
    }
    .sikaku.selected {
      border: 6px solid red;
      box-shadow: 0 0 12px #f00a;
    }
    #counter {
      position:fixed; right:24px; bottom:24px; z-index:10; background:#fff; border-radius:24px;
      padding:24px 70px; font-size:8em; box-shadow:0 2px 30px #0003; min-width:2em; min-height:1.2em;
      display:flex; align-items:center; justify-content:center; user-select:none;
    }
    #matome-btn-20, #matome-btn-30, #matome-btn-40 {
      position:fixed; right:24px; z-index:20; font-size:2em; padding:0.5em 1.5em; border-radius:1em;
      border:none; background:#4af; color:#fff; font-weight:bold; box-shadow:0 2px 8px #0002; display:none;
    }
    #matome-btn-20 { bottom:calc(24px + 8em); }
    #matome-btn-30 { bottom:calc(24px + 11em); }
    #matome-btn-40 { bottom:calc(24px + 14em); }
    #counter.writing { outline:2px solid #4af; }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="counter"> </div>
  <button id="answer-btn" style="position:fixed;right:24px;bottom:8em;z-index:30;font-size:2em;padding:0.5em 1.5em;border-radius:1em;border:none;background:#f80;color:#fff;font-weight:bold;box-shadow:0 2px 8px #0002;">解答</button>
  <button id="matome-btn-rest" style="position:fixed;right:24px;bottom:calc(8em + 3em);z-index:31;font-size:2em;padding:0.5em 1.5em;border-radius:1em;border:none;background:#4af;color:#fff;font-weight:bold;box-shadow:0 2px 8px #0002;">端数まとめ</button>
  <div id="quiz-result" style="position:fixed;right:24px;bottom:calc(24px + 17em);z-index=41;font-size:2em;font-weight:bold;color:#222;background:#fff8;border-radius:1em;padding:0.5em 1.5em;display:none;pointer-events:none;"></div>
  <canvas id="answer-mark" style="position:fixed;right:24px;bottom:24px;z-index=42;pointer-events:none;" width="180" height="180"></canvas>
  <audio id="se" src="sikaku.png/../p.mp3"></audio>
  <audio id="seikai-audio" src="seikai.mp3"></audio>
  <audio id="hazure-audio" src="hazure.mp3"></audio>
  <button id="reset-btn" style="position:fixed;left:24px;top:24px;z-index=50;font-size:1.5em;padding:0.4em 1.2em;border-radius:1em;border:none;background:#eee;color:#333;font-weight:bold;box-shadow:0 2px 8px #0002;">リセット</button>
  <button id="auto10-btn" style="position:fixed;left:180px;top:24px;z-index=50;margin-right:16px;font-size:1.5em;padding:0.4em 1.2em;border-radius:1em;border:none;background:#4af;color:#fff;font-weight:bold;box-shadow:0 2px 8px #0002;">10まとめ</button>
  <button id="auto20-btn" style="position:fixed;left:340px;top:24px;z-index=50;margin-right:16px;font-size:1.5em;padding:0.4em 1.2em;border-radius:1em;border:none;background:#4af;color:#fff;font-weight:bold;box-shadow:0 2px 8px #0002;">20まとめ</button>
  <button id="auto30-btn" style="position:fixed;left:500px;top:24px;z-index=50;margin-right:16px;font-size:1.5em;padding:0.4em 1.2em;border-radius:1em;border:none;background:#4af;color:#fff;font-weight:bold;box-shadow:0 2px 8px #0002;">30まとめ</button>
  <script>
    let touchStartY = 0;
    window.addEventListener('touchstart', function(e) {
      if(e.touches.length === 1) {
        touchStartY = e.touches[0].clientY;
      }
    }, {passive:false});
    window.addEventListener('touchmove', function(e) {
      if(e.touches.length === 1) {
        const deltaY = e.touches[0].clientY - touchStartY;
        if(deltaY > 10 && window.scrollY === 0) {
          e.preventDefault();
        }
      }
    }, {passive:false});
    const NUM_TOTAL = 40;
    const IMG_SIZE = 64;
    const MARGIN = 8;
    const container = document.getElementById('container');
    const counter = document.getElementById('counter');
    const se = document.getElementById('se');
    let selected = [];
    let count = 0;
    let phase = 1;
    let sikakus = [];
    function speakNum(n) {
      const ja = ['','いち','に','さん','よん','ご','ろく','なな','はち','きゅう'];
      let text = '';
      if(n<=10) text = ja[n];
      else if(n<20) text = 'じゅう'+ja[n-10];
      else text = 'にじゅう';
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP';
      window.speechSynthesis.speak(u);
    }
    function isOverlap(x,y,arr) {
      for(const o of arr) {
        if(Math.abs(o.x-x)<IMG_SIZE+MARGIN && Math.abs(o.y-y)<IMG_SIZE+MARGIN) return true;
      }
      return false;
    }
    function getRect(id) {
      const el = document.getElementById(id);
      if(!el) return null;
      return el.getBoundingClientRect();
    }
    const avoidRects = [];
    ['counter','quiz-result','matome-btn-20','matome-btn-30','matome-btn-40','reset-btn'].forEach(id => {
      const r = getRect(id);
      if(r) avoidRects.push(r);
    });
    function isAvoid(x, y) {
      for(const r of avoidRects) {
        if(x+IMG_SIZE > r.left && x < r.right && y+IMG_SIZE > r.top && y < r.bottom) return true;
      }
      return false;
    }
    function placeSikakus() {
      sikakus = [];
      container.innerHTML = '';
      const w = window.innerWidth * 0.7, h = window.innerHeight * 0.7;
      const offsetX = (window.innerWidth - w) / 2;
      const offsetY = (window.innerHeight - h) / 2;
      for(let i=0;i<NUM_TOTAL;i++) {
        let x,y,ok=false;
        for(let t=0;t<300;t++) {
          x = Math.random()*(w-IMG_SIZE-2*MARGIN)+MARGIN + offsetX;
          y = Math.random()*(h-IMG_SIZE-2*MARGIN)+MARGIN + offsetY;
          if(!isOverlap(x,y,sikakus) && !isAvoid(x,y)) { ok=true; break; }
        }
        if(!ok) {
          x = offsetX + (i%8)*80;
          y = offsetY + Math.floor(i/8)*80;
        }
        sikakus.push({x,y,idx:i,el:null,selected:false});
      }
      for(const s of sikakus) {
        const div = document.createElement('div');
        div.className = 'sikaku';
        div.style.left = s.x+'px';
        div.style.top = s.y+'px';
        div.innerHTML = `<img src="sikaku.png" width="64" height="64">`;
        div.addEventListener('click',()=>onSikakuClick(s));
        div.addEventListener('touchstart',e=>{e.preventDefault();onSikakuClick(s);});
        s.el = div;
        container.appendChild(div);
      }
    }
    function onSikakuClick(s) {
      if(s.selected) return;
      if(count>=NUM_TOTAL) return;
      s.selected = true;
      count++;
      se.currentTime=0; se.play();
      s.el.classList.add('selected');
      s.el.style.transform = 'scale(1.2)';
      setTimeout(()=>{s.el.style.transform='scale(1)';},180);
      updateCounter(count);
      selected.push(s);
      showMatomeBtns();
    }
    function groupSelected(num) {
      // 10個単位で左側に並べる
      const w = window.innerWidth, h = window.innerHeight;
      const groupImgSize = 48;
      const marginForGroup = 6;
      const groupMargin = 32;
      let arr = selected.slice(0,num);
      let groupCount = Math.floor(num/10);
      for(let g=0;g<groupCount;g++) {
        for(let i=0;i<10;i++) {
          const idx = g*10+i;
          const col = i%2, row = Math.floor(i/2);
          const tx = 24 + g*(2*groupImgSize+groupMargin);
          const ty = h/2 - groupImgSize*5 + row * (groupImgSize + marginForGroup);
          const el = arr[idx].el;
          el.style.transition = 'left 1s, top 1s, width 0.5s, height 0.5s';
          setTimeout(()=>{
            el.style.left = tx + col * (groupImgSize + marginForGroup) + 'px';
            el.style.top = ty + 'px';
            el.style.width = groupImgSize+'px';
            el.style.height = groupImgSize+'px';
            const img = el.querySelector('img');
            if(img) {
              img.width = groupImgSize;
              img.height = groupImgSize;
              img.style.width = groupImgSize+'px';
              img.style.height = groupImgSize+'px';
            }
          }, 50);
          arr[idx].x = tx + col * (groupImgSize + marginForGroup);
          arr[idx].y = ty;
          el.style.zIndex = 5;
        }
      }
    }
    function groupRestSelected(restStart, rest) {
      // 端数をまとめて左側に配置
      const w = window.innerWidth, h = window.innerHeight;
      const groupImgSize = 48;
      const marginForGroup = 6;
      const startX = 24;
      const startY = h/2 - groupImgSize*5;
      let arr = selected.slice(restStart, restStart+rest);
      for(let i=0;i<arr.length;i++) {
        const col = i%2, row = Math.floor(i/2);
        const tx = startX + col * (groupImgSize + marginForGroup);
        const ty = startY + row * (groupImgSize + marginForGroup);
        const el = arr[i].el;
        el.style.transition = 'left 1s, top 1s, width 0.5s, height 0.5s';
        setTimeout(()=>{
          el.style.left = tx+'px';
          el.style.top = ty+'px';
          el.style.width = groupImgSize+'px';
          el.style.height = groupImgSize+'px';
          const img = el.querySelector('img');
          if(img) {
            img.width = groupImgSize;
            img.height = groupImgSize;
            img.style.width = groupImgSize+'px';
            img.style.height = groupImgSize+'px';
          }
        }, 50);
        arr[i].x = tx; arr[i].y = ty;
        el.style.zIndex = 5;
      }
    }
    function updateCounter(n) {
      // カウント表示は不要
      counter.innerHTML = '';
      document.getElementById('answer-btn').style.display = 'block';
    }
    // 手書き入力
    let drawing = false, lastX=0, lastY=0, ctx, canvas;
    function enableCounterDraw(e) {
      if(count<10) return;
      if(document.getElementById('counter-canvas')) return;
      const counterRect = counter.getBoundingClientRect();
      canvas = document.createElement('canvas');
      canvas.id = 'counter-canvas';
      canvas.width = counterRect.width*2;
      canvas.height = counterRect.height*2;
      canvas.style.position = 'absolute';
      canvas.style.left = 0;
      canvas.style.top = 0;
      canvas.style.width = '100%';
      canvas.style.height = '100%';
      canvas.style.pointerEvents = 'auto';
      canvas.style.zIndex = 3;
      counter.appendChild(canvas);
      ctx = canvas.getContext('2d');
      ctx.lineWidth = 54;
      ctx.strokeStyle = '#1a1a1a';
      ctx.lineCap = 'round';
      function getXY(e) {
        if(e.touches) {
          const rect = canvas.getBoundingClientRect();
          return [ (e.touches[0].clientX-rect.left)*2, (e.touches[0].clientY-rect.top)*2 ];
        } else {
          return [ e.offsetX*2, e.offsetY*2 ];
        }
      }
      function startDraw(e) {
        drawing = true; counter.classList.add('writing');
        [lastX,lastY] = getXY(e);
      }
      function moveDraw(e) {
        if(!drawing) return;
        const [x,y] = getXY(e);
        ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke();
        [lastX,lastY] = [x,y];
      }
      function endDraw() { drawing=false; counter.classList.remove('writing'); }
      canvas.addEventListener('mousedown',startDraw);
      canvas.addEventListener('mousemove',moveDraw);
      canvas.addEventListener('mouseup',endDraw);
      canvas.addEventListener('mouseleave',endDraw);
      canvas.addEventListener('touchstart',startDraw);
      canvas.addEventListener('touchmove',moveDraw);
      canvas.addEventListener('touchend',endDraw);
    }
    counter.addEventListener('mousedown',enableCounterDraw);
    counter.addEventListener('touchstart',enableCounterDraw);
    document.getElementById('answer-btn').onclick = async function() {
      const quizResult = document.getElementById('quiz-result');
      quizResult.style.display = 'none';
      const canvas = document.getElementById('counter-canvas');
      if(!canvas) { 
        quizResult.textContent = '手書きで数字を書いてください'; 
        quizResult.style.display = 'block'; 
        // 認識失敗時の記号
        const answerMark = document.getElementById('answer-mark');
        const ctxMark = answerMark.getContext('2d');
        ctxMark.clearRect(0,0,180,180);
        ctxMark.font = 'bold 120px sans-serif';
        ctxMark.fillStyle = 'red';
        ctxMark.textAlign = 'center';
        ctxMark.textBaseline = 'middle';
        ctxMark.fillText('？', 90, 100);
        return; 
      }
      const dataUrl = canvas.toDataURL('image/png');
      quizResult.textContent = '認識中...'; quizResult.style.display = 'block';
      const { data: { text } } = await Tesseract.recognize(dataUrl, 'eng', { tessedit_char_whitelist: '0123456789' });
      const ans = text.replace(/\D/g,'').slice(0,2); // 2桁のみ
      const answerMark = document.getElementById('answer-mark');
      const ctxMark = answerMark.getContext('2d');
      ctxMark.clearRect(0,0,180,180);
      const expected = count.toString().padStart(2,'0');
      if(!ans || ans.length!==2) {
        quizResult.textContent = '認識できませんでした';
        quizResult.style.color = '#222';
        ctxMark.font = 'bold 120px sans-serif';
        ctxMark.fillStyle = 'red';
        ctxMark.textAlign = 'center';
        ctxMark.textBaseline = 'middle';
        ctxMark.fillText('？', 90, 100);
        if(canvas) canvas.remove();
        return;
      }
      if(ans === expected) {
        quizResult.textContent = '正解！';
        quizResult.style.color = '#080';
        document.getElementById('seikai-audio').currentTime = 0;
        document.getElementById('seikai-audio').play();
        ctxMark.beginPath();
        ctxMark.arc(90,90,70,0,2*Math.PI);
        ctxMark.lineWidth = 12;
        ctxMark.strokeStyle = 'green';
        ctxMark.stroke();
      } else {
        quizResult.textContent = `間違い（あなたの答え:${ans}）`;
        quizResult.style.color = '#d00';
        document.getElementById('hazure-audio').currentTime = 0;
        document.getElementById('hazure-audio').play();
        ctxMark.font = 'bold 120px sans-serif';
        ctxMark.fillStyle = 'red';
        ctxMark.textAlign = 'center';
        ctxMark.textBaseline = 'middle';
        ctxMark.fillText('？', 90, 100);
        if(canvas) canvas.remove();
      }
    };
    document.getElementById('reset-btn').onclick = function() {
      window.location.reload();
    };
    document.getElementById('auto10-btn').onclick = function() {
      if(count >= 10) return;
      let n = count;
      for(const s of sikakus) {
        if(!s.selected && n < 10) {
          s.selected = true;
          n++;
          s.el.classList.add('selected');
          s.el.style.transform = 'scale(1.2)';
          setTimeout(()=>{s.el.style.transform='scale(1)';},180);
          selected.push(s);
        }
      }
      count = 10;
      updateCounter(10);
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance('じゅう、いっかいまとめます');
      u.lang = 'ja-JP';
      window.speechSynthesis.speak(u);
      setTimeout(()=>{groupSelected(10);},1200);
    };
    document.getElementById('auto20-btn').onclick = function() {
      if(count >= 20) return;
      let n = count;
      for(const s of sikakus) {
        if(!s.selected && n < 20) {
          s.selected = true;
          n++;
          s.el.classList.add('selected');
          s.el.style.transform = 'scale(1.2)';
          setTimeout(()=>{s.el.style.transform='scale(1)';},180);
          selected.push(s);
        }
      }
      count = 20;
      updateCounter(20);
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance('にじゅう、まとめます');
      u.lang = 'ja-JP';
      window.speechSynthesis.speak(u);
      setTimeout(()=>{groupSelected(20);},1200);
    };
    document.getElementById('auto30-btn').onclick = function() {
      if(count >= 30) return;
      let n = count;
      for(const s of sikakus) {
        if(!s.selected && n < 30) {
          s.selected = true;
          n++;
          s.el.classList.add('selected');
          s.el.style.transform = 'scale(1.2)';
          setTimeout(()=>{s.el.style.transform='scale(1)';},180);
          selected.push(s);
        }
      }
      count = 30;
      updateCounter(30);
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance('さんじゅう、まとめます');
      u.lang = 'ja-JP';
      window.speechSynthesis.speak(u);
      setTimeout(()=>{groupSelected(30);},1200);
    };
    document.getElementById('matome-btn-rest').onclick = function() {
      // 選択済みsikaku.pngを横2×縦5の塊として右横にスペースをあけて並べる
      groupRestBlocks();
    };
    function showMatomeBtns() {
      // 右側まとめボタンは表示しない
      // 端数まとめボタンは左上に表示済み
    }
    function groupAllSelected() {
      // 選択済みsikaku.pngを横2×縦5で左側にまとめる
      const w = window.innerWidth, h = window.innerHeight;
      const groupImgSize = 48;
      const marginForGroup = 6;
      const startX = 24;
      const startY = h/2 - groupImgSize*5;
      let arr = selected;
      for(let i=0;i<arr.length;i++) {
        const col = i%2, row = Math.floor(i/2);
        const tx = startX + col * (groupImgSize + marginForGroup);
        const ty = startY + row * (groupImgSize + marginForGroup);
        const el = arr[i].el;
        el.style.transition = 'left 1s, top 1s, width 0.5s, height 0.5s';
        setTimeout(()=>{
          el.style.left = tx+'px';
          el.style.top = ty+'px';
          el.style.width = groupImgSize+'px';
          el.style.height = groupImgSize+'px';
          const img = el.querySelector('img');
          if(img) {
            img.width = groupImgSize;
            img.height = groupImgSize;
            img.style.width = groupImgSize+'px';
            img.style.height = groupImgSize+'px';
          }
        }, 50);
        arr[i].x = tx; arr[i].y = ty;
        el.style.zIndex = 5;
      }
    }
    function groupRestBlocks() {
      // 横2×縦5の塊を右横にスペースをあけて並べる
      const w = window.innerWidth, h = window.innerHeight;
      const groupImgSize = 48;
      const marginForGroup = 6;
      const blockMargin = 32;
      let arr = selected;
      let blockCount = Math.ceil(arr.length/10);
      for(let b=0;b<blockCount;b++) {
        for(let i=0;i<10;i++) {
          const idx = b*10+i;
          if(idx >= arr.length) break;
          const col = i%2, row = Math.floor(i/2);
          const tx = 24 + b*(2*groupImgSize+blockMargin) + col * (groupImgSize + marginForGroup);
          const ty = h/2 - groupImgSize*5 + row * (groupImgSize + marginForGroup);
          const el = arr[idx].el;
          el.style.transition = 'left 1s, top 1s, width 0.5s, height 0.5s';
          setTimeout(()=>{
            el.style.left = tx+'px';
            el.style.top = ty+'px';
            el.style.width = groupImgSize+'px';
            el.style.height = groupImgSize+'px';
            const img = el.querySelector('img');
            if(img) {
              img.width = groupImgSize;
              img.height = groupImgSize;
              img.style.width = groupImgSize+'px';
              img.style.height = groupImgSize+'px';
            }
          }, 50);
          arr[idx].x = tx; arr[idx].y = ty;
          el.style.zIndex = 5;
        }
      }
    }
    window.addEventListener('resize',placeSikakus);
    placeSikakus();
  </script>
</body>
</html>
