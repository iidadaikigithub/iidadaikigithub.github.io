<!DOCTYPE html>
<html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>トーマス クイズ</title>
  <style>
    :root {
      --dark-border: #000;
      --light-bg: #fff;
      --selected-bg: #007bff;
      --selected-text: #fff;
      --correct-flash: #28a745;
    }
    html, body {
      overscroll-behavior: none; touch-action: manipulation; user-select: none;
      -webkit-user-select: none; overflow: hidden; width: 100%; height: 100%;
      margin: 0; padding: 0;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center;
      display: flex; justify-content: center; align-items: center; background: var(--light-bg);
    }
    .container {
      width: 100%; height: 100%; display: flex; flex-direction: column;
      justify-content: center; align-items: center; padding: 2vw; box-sizing: border-box;
    }
    .hidden { display: none !important; }

    /* Settings Screen */
    #settingsContainer h1 { font-size: clamp(24px, 6vw, 48px); }
    .setting-group { margin-bottom: 20px; width: 90%; }
    .setting-group h2 { font-size: clamp(18px, 4vw, 32px); }
    .button-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .setting-btn {
      font-size: clamp(14px, 3.5vw, 24px); padding: 10px 15px; border-radius: 8px;
      border: 2px solid var(--dark-border); background-color: var(--light-bg); cursor: pointer;
    }
    .setting-btn.selected { background-color: var(--selected-bg); color: var(--selected-text); }
    #startButton {
      font-size: clamp(20px, 5vw, 40px); padding: 15px 30px; border-radius: 15px;
      border: 3px solid var(--dark-border); background-color: #28a745; color: white;
      cursor: pointer; margin-top: 20px;
    }

    /* Quiz Screen */
    #quizContainer { display: grid; grid-template-rows: auto 1fr; gap: 1vh; padding-bottom: 1vh; }
    #questionWrapper { display: flex; justify-content: center; align-items: center; }
    #question { font-size: clamp(20px, 4vw, 36px); font-weight: bold; }
    #speakBtn { font-size: clamp(24px, 5vw, 40px); background: none; border: none; cursor: pointer; margin-left: 15px; }
    #options { display: grid; gap: 1.5vw; width: 100%; height: 100%; }
    .options-2 { grid-template-columns: repeat(2, 1fr); }
    .options-3 { grid-template-columns: repeat(3, 1fr); }
    .options-4 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
    .option-img {
      width: 100%; height: 100%; object-fit: contain; cursor: pointer;
      border: 0.5vw solid var(--dark-border); border-radius: 2vw; background: var(--light-bg);
      box-sizing: border-box; min-height: 0;
    }
    .no-events { pointer-events: none; }

    /* Animations */
    .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    
    .flash-border { animation: flash-border 0.5s 3; }
    @keyframes flash-border { 50% { border-color: var(--correct-flash); box-shadow: 0 0 20px var(--correct-flash); } }

    .speaking { animation: speak-bounce 0.5s ease-in-out; }
    @keyframes speak-bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

    #resultGifContainer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center;
        background-color: rgba(255, 255, 255, 0.5);
    }
    #resultGif { max-width: 80%; max-height: 80%; }
    #endMessage { font-size: 8vw; font-weight: bold; }
  </style>
</head>
<body>

<div id="settingsContainer" class="container">
  <h1>クイズのせってい</h1>
  <div class="setting-group">
    <h2>なんもんやる？</h2>
    <div id="numQuestionsGrid" class="button-grid"></div>
  </div>
  <div class="setting-group">
    <h2>いくつからえらぶ？</h2>
    <div id="numOptionsGrid" class="button-grid"></div>
  </div>
  <div class="setting-group">
    <h2>BGMは？</h2>
    <div id="bgmGrid" class="button-grid"></div>
  </div>
  <button id="startButton">スタート！</button>
</div>

<div id="quizContainer" class="container hidden">
  <div id="questionWrapper">
    <span id="question"></span>
    <button id="speakBtn">🎤</button>
  </div>
  <div id="options"></div>
</div>

<div id="endContainer" class="container hidden">
  <h2 id="endMessage">おつかれさまでした！</h2>
</div>

<div id="resultGifContainer" class="hidden">
    <img id="resultGif" src="クイズ_files/seikai.gif">
</div>

<audio id="seikaiAudio" src="seikai.mp3"></audio>
<audio id="batuAudio" src="batu.mp3"></audio>
<audio id="bgmAudio" src="bgm1.mp3" loop></audio>

<script>
  const quizData = [
    { name: "トーマス", image: "トーマス.jpg" }, { name: "パーシー", image: "パーシー.jpg" },
    { name: "ニア", image: "ニア.jpg" }, { name: "カナ", image: "カナ.jpg" },
    { name: "ディーゼル", image: "ディーゼル.jpg" }, { name: "ブルーノ", image: "ブルーノ.jpg" },
    { name: "カーリー", image: "カーリー.jpg" }, { name: "サンディー", image: "サンディー.jpg" },
    { name: "ゴードン", image: "ゴードン.jpg" }, { name: "ヒロ", image: "ヒロ.jpg" },
    { name: "ハロルド", image: "ハロルド.jpg" }, { name: "トップハム・ハット", image: "トップハム・ハット.jpg" },
    { name: "ケンジ", image: "ケンジ.jpg" }, { name: "ジェームス", image: "ジェームス.jpg" },
    { name: "エミリー", image: "エミリー.jpg" }, { name: "トビー", image: "トビー.jpg" },
    { name: "ウィフ", image: "ウィフ.jpg" }, { name: "ダーシー", image: "ダーシー.jpg" },
    { name: "クランキー", image: "クランキー.jpg" }, { name: "アニーとクララベル", image: "アニーとクララベル.jpg" },
    { name: "いたずら・いじわるかしゃ", image: "いたずら・いじわるかしゃ.jpg" }
  ];

  let totalQuestions = 0, numOptions = 0, questionsAnswered = 0, currentCorrectAnswer = null, questionPool = [], playBGM = false;

  const settingsContainer = document.getElementById('settingsContainer');
  const quizContainer = document.getElementById('quizContainer');
  const endContainer = document.getElementById('endContainer');
  const startButton = document.getElementById('startButton');
  const questionEl = document.getElementById('question');
  const questionWrapper = document.getElementById('questionWrapper');
  const optionsEl = document.getElementById('options');
  const speakBtn = document.getElementById('speakBtn');
  const resultGifContainer = document.getElementById('resultGifContainer');
  const seikaiAudio = document.getElementById('seikaiAudio');
  const batuAudio = document.getElementById('batuAudio');
  const bgmAudio = document.getElementById('bgmAudio');

  function setupSettings() {
    const numQuestionsGrid = document.getElementById('numQuestionsGrid');
    for (let i = 1; i <= 20; i++) {
      const btn = document.createElement('button');
      btn.textContent = i; btn.className = 'setting-btn'; btn.dataset.value = i;
      btn.addEventListener('click', (e) => selectSetting(e.target, 'numQuestions'));
      numQuestionsGrid.appendChild(btn);
    }
    const numOptionsGrid = document.getElementById('numOptionsGrid');
    [2, 3, 4].forEach(num => {
      const btn = document.createElement('button');
      btn.textContent = `${num}たく`; btn.className = 'setting-btn'; btn.dataset.value = num;
      btn.addEventListener('click', (e) => selectSetting(e.target, 'numOptions'));
      numOptionsGrid.appendChild(btn);
    });
    const bgmGrid = document.getElementById('bgmGrid');
    [{text: 'あり', value: true}, {text: 'なし', value: false}].forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt.text; btn.className = 'setting-btn'; btn.dataset.value = opt.value;
        btn.addEventListener('click', (e) => selectSetting(e.target, 'bgm'));
        bgmGrid.appendChild(btn);
    });
  }

  function selectSetting(selectedBtn, group) {
    const parent = selectedBtn.parentElement;
    parent.querySelectorAll('.setting-btn').forEach(btn => btn.classList.remove('selected'));
    selectedBtn.classList.add('selected');
    if (group === 'numQuestions') totalQuestions = parseInt(selectedBtn.dataset.value);
    if (group === 'numOptions') numOptions = parseInt(selectedBtn.dataset.value);
    if (group === 'bgm') playBGM = selectedBtn.dataset.value === 'true';
  }

  function startQuiz() {
    if (totalQuestions === 0 || numOptions === 0) {
      alert('もんだいのかずと、いくつからえらぶか、りょうほうえらんでね！'); return;
    }
    if (playBGM) {
        bgmAudio.currentTime = 0;
        bgmAudio.play();
    }
    questionsAnswered = 0;
    questionPool = [...quizData].sort(() => 0.5 - Math.random());
    settingsContainer.classList.add('hidden');
    quizContainer.classList.remove('hidden');
    loadQuestion();
  }

  function loadQuestion() {
    if (questionsAnswered >= totalQuestions || questionPool.length === 0) { endQuiz(); return; }
    optionsEl.innerHTML = '';

    const correctItem = questionPool.pop();
    currentCorrectAnswer = correctItem.name;
    questionEl.textContent = `${correctItem.name} は どれ？`;

    let options = [correctItem];
    const otherItems = quizData.filter(item => item.name !== correctItem.name).sort(() => 0.5 - Math.random());
    options = options.concat(otherItems.slice(0, numOptions - 1));

    const shuffledOptions = options.sort(() => 0.5 - Math.random());

    optionsEl.className = `options-${numOptions}`;
    shuffledOptions.forEach(item => {
      const img = document.createElement('img');
      img.src = `クイズ_files/${item.image}`; img.alt = item.name; img.className = 'option-img';
      img.addEventListener('click', (e) => checkAnswer(item.name, e.target));
      optionsEl.appendChild(img);
    });
  }

  function checkAnswer(selectedName, imgEl) {
    optionsEl.classList.add('no-events'); // Disable further clicks
    if (selectedName === currentCorrectAnswer) {
      batuAudio.pause(); batuAudio.currentTime = 0;
      seikaiAudio.currentTime = 0;
      seikaiAudio.play();
      resultGifContainer.classList.remove('hidden');
      imgEl.classList.add('flash-border');
      setTimeout(() => {
        resultGifContainer.classList.add('hidden');
        imgEl.classList.remove('flash-border');
        questionsAnswered++;
        loadQuestion();
        optionsEl.classList.remove('no-events');
      }, 2000);
    } else {
      seikaiAudio.pause(); seikaiAudio.currentTime = 0;
      batuAudio.currentTime = 0;
      batuAudio.play();
      imgEl.classList.add('shake');
      setTimeout(() => {
        imgEl.classList.remove('shake');
        optionsEl.classList.remove('no-events');
      }, 500);
    }
  }

  function endQuiz() {
    quizContainer.classList.add('hidden');
    endContainer.classList.remove('hidden');
    if(playBGM) {
        bgmAudio.pause();
    }
  }

  function speak(text) {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ja-JP';
      utterance.onstart = () => questionWrapper.classList.add('speaking');
      utterance.onend = () => questionWrapper.classList.remove('speaking');
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }
  }

  speakBtn.addEventListener('click', () => speak(questionEl.textContent));
  startButton.addEventListener('click', startQuiz);
  setupSettings();
</script>
</body>
</html>
