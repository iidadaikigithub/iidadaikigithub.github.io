<!DOCTYPE html>
<html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>タイヤ クイズ</title>
  <style>
    :root {
      --dark-border: #000;
      --light-bg: #fff;
      --selected-bg: #007bff;
      --selected-text: #fff;
      --correct-flash: #28a745;
    }
    html, body {
      overscroll-behavior: none; touch-action: manipulation; user-select: none;
      -webkit-user-select: none; overflow-y: auto; width: 100%; min-height: 100%;
      margin: 0; padding: 0;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center;
      display: flex; justify-content: center; align-items: center; background: var(--light-bg);
    }
    .container {
      width: 100%; min-height: 100vh; display: flex; flex-direction: column;
      justify-content: flex-start; align-items: center; padding: 4vw 2vw 2vw 2vw; box-sizing: border-box;
    }
    .hidden { display: none !important; }

    /* Settings Screen */
    #settingsContainer h1 { font-size: clamp(24px, 6vw, 48px); }
    .setting-group { margin-bottom: 20px; width: 90%; }
    .setting-group h2 { font-size: clamp(18px, 4vw, 32px); }
    .button-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 3vw;
      width: 100%;
      margin-bottom: 2vw;
    }
    .setting-btn {
      font-size: clamp(18px, 5vw, 28px);
      padding: 2vw 5vw;
      border-radius: 2vw;
      border: 2px solid var(--dark-border);
      background-color: var(--light-bg);
      cursor: pointer;
      min-width: 18vw;
      min-height: 8vw;
      box-sizing: border-box;
    }
    .setting-btn.selected { background-color: var(--selected-bg); color: var(--selected-text); }

    /* Quiz Screen */
    #quizContainer { display: grid; grid-template-rows: auto 1fr; gap: 1vh; padding-bottom: 1vh; }
    #questionWrapper { display: flex; justify-content: center; align-items: center; }
    #question { font-size: clamp(20px, 4vw, 36px); font-weight: bold; }
    #options { display: grid; gap: 1.5vw; width: 100%; height: 100%; }
    .options-2 { grid-template-columns: repeat(2, 1fr); }
    .options-3 { grid-template-columns: repeat(3, 1fr); }
    .options-4 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
    .option-img {
      width: 100%; height: 100%; object-fit: contain; cursor: pointer;
      border: 0.5vw solid var(--dark-border); border-radius: 2vw; background: var(--light-bg);
      box-sizing: border-box; min-height: 0;
    }
    .no-events { pointer-events: none; }

    /* Animations */
    .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    #endMessage { font-size: 8vw; font-weight: bold; }
  </style>
</head>
<body>

<div id="settingsContainer" class="container">
  <h1>クイズのせってい</h1>
  <div class="setting-group">
    <h2>なんもんやる？</h2>
    <div id="numQuestionsGrid" class="button-grid"></div>
  </div>
  <div class="setting-group">
    <h2>いくつからえらぶ？</h2>
    <div id="numOptionsGrid" class="button-grid"></div>
  </div>
  <div class="setting-group">
    <h2>BGMは？</h2>
    <div id="bgmGrid" class="button-grid"></div>
  </div>
</div>

<div id="quizContainer" class="container hidden">
  <div id="questionWrapper">
    <span id="question"></span>
    <img id="questionImage" src="">
  </div>
  <div id="options"></div>
</div>

<div id="endContainer" class="container hidden">
  <h2 id="endMessage">おつかれさまでした！</h2>
</div>

<audio id="correctAudio" src="maru.mp3"></audio>
<audio id="incorrectAudio" src="hazure.mp3"></audio>
<audio id="bgmAudio" src="bgm1.mp3" loop></audio>

<script>
  const quizData = [];
  for (let i = 1; i <= 30; i++) {
    const num = i < 10 ? '0' + i : i;
    quizData.push({ name: `t${num}`, image: `t${num}.jpg` });
  }

  let totalQuestions = 0, numOptions = 0, questionsAnswered = 0, currentCorrectAnswer = null, questionPool = [], playBGM = false;
  const settingsContainer = document.getElementById('settingsContainer');
  const quizContainer = document.getElementById('quizContainer');
  const endContainer = document.getElementById('endContainer');
  const questionEl = document.getElementById('question');
  const questionImageEl = document.getElementById('questionImage');
  const optionsEl = document.getElementById('options');
  const correctAudio = document.getElementById('correctAudio');
  const incorrectAudio = document.getElementById('incorrectAudio');
  const bgmAudio = document.getElementById('bgmAudio');

  function setupSettings() {
    const numQuestionsGrid = document.getElementById('numQuestionsGrid');
    for (let i = 1; i <= 20; i++) {
      const btn = document.createElement('button');
      btn.textContent = i; btn.className = 'setting-btn'; btn.dataset.value = i;
      btn.addEventListener('click', (e) => selectSetting(e.target, 'numQuestions'));
      numQuestionsGrid.appendChild(btn);
    }
    const numOptionsGrid = document.getElementById('numOptionsGrid');
    [2, 3, 4].forEach(num => {
      const btn = document.createElement('button');
      btn.textContent = `${num}たく`; btn.className = 'setting-btn'; btn.dataset.value = num;
      btn.addEventListener('click', (e) => selectSetting(e.target, 'numOptions'));
      numOptionsGrid.appendChild(btn);
    });
    const bgmGrid = document.getElementById('bgmGrid');
    // BGM初期値OFF（なし）
    let bgmDefaultSet = false;
    [{text: 'あり', value: true}, {text: 'なし', value: false}].forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt.text; btn.className = 'setting-btn'; btn.dataset.value = opt.value;
        btn.addEventListener('click', (e) => selectSetting(e.target, 'bgm'));
        bgmGrid.appendChild(btn);
        if (!bgmDefaultSet && opt.value === false) {
          btn.classList.add('selected');
          playBGM = false;
          bgmDefaultSet = true;
        }
    });
  }

  function selectSetting(selectedBtn, group) {
  const parent = selectedBtn.parentElement;
  parent.querySelectorAll('.setting-btn').forEach(btn => btn.classList.remove('selected'));
  selectedBtn.classList.add('selected');
  if (group === 'numQuestions') totalQuestions = parseInt(selectedBtn.dataset.value);
  if (group === 'numOptions') numOptions = parseInt(selectedBtn.dataset.value);
  if (group === 'bgm') playBGM = selectedBtn.dataset.value === 'true';
  // すべて選択済みなら自動でクイズ開始
  if (totalQuestions > 0 && numOptions > 0 && (playBGM === true || playBGM === false)) {
    startQuiz();
  }
  }

  function startQuiz() {
    if (totalQuestions === 0 || numOptions === 0) {
      alert('もんだいのかずと、いくつからえらぶか、りょうほうえらんでね！'); return;
    }
    if (playBGM) {
        bgmAudio.currentTime = 0;
        bgmAudio.play();
    }
    questionsAnswered = 0;
    questionPool = [...quizData].sort(() => 0.5 - Math.random());
    settingsContainer.classList.add('hidden');
    quizContainer.classList.remove('hidden');
    loadQuestion();
  }

  function loadQuestion() {
    if (questionsAnswered >= totalQuestions || questionPool.length === 0) { endQuiz(); return; }
    optionsEl.innerHTML = '';

    const correctItem = questionPool.pop();
    currentCorrectAnswer = correctItem.name;
    questionEl.textContent = `これとおなじものはどれ？ (${questionsAnswered + 1}/${totalQuestions})`;
    questionImageEl.src = correctItem.image;

    let options = [correctItem];
    const otherItems = quizData.filter(item => item.name !== correctItem.name).sort(() => 0.5 - Math.random());
    options = options.concat(otherItems.slice(0, numOptions - 1));

    const shuffledOptions = options.sort(() => 0.5 - Math.random());

    optionsEl.className = `options-${numOptions}`;
    shuffledOptions.forEach(item => {
      const img = document.createElement('img');
      img.src = item.image; img.alt = item.name; img.className = 'option-img';
      img.addEventListener('click', (e) => checkAnswer(item.name, e.target));
      optionsEl.appendChild(img);
    });
  }

  function checkAnswer(selectedName, imgEl) {
    optionsEl.classList.add('no-events');
  const startRect = imgEl.getBoundingClientRect();
  const endRect = questionImageEl.getBoundingClientRect();
  // スマホでも必ず画面左端＋余白にスライド
  const leftX = 20; // 画面左端から20px
  const leftY = endRect.top;
    const clone = imgEl.cloneNode(true);
    clone.style.position = 'fixed';
    clone.style.left = `${startRect.left}px`;
    clone.style.top = `${startRect.top}px`;
    clone.style.width = `${startRect.width}px`;
    clone.style.height = `${startRect.height}px`;
    clone.style.transition = 'all 1s ease-in-out';
    clone.style.zIndex = 100;
    document.body.appendChild(clone);
    imgEl.style.visibility = 'hidden';

    // まず左側にスライド
    setTimeout(() => {
      clone.style.left = `${leftX}px`;
      clone.style.top = `${leftY}px`;
      clone.style.width = `${endRect.width}px`;
      clone.style.height = `${endRect.height}px`;
    }, 100);

    // 1秒後、問題画像に合わさる
    setTimeout(() => {
      clone.style.left = `${endRect.left}px`;
      clone.style.top = `${endRect.top}px`;
      clone.style.width = `${endRect.width}px`;
      clone.style.height = `${endRect.height}px`;
    }, 1100);

    if (selectedName === currentCorrectAnswer) {
      setTimeout(() => {
        correctAudio.currentTime = 0;
        correctAudio.play();
        document.body.removeChild(clone);
        questionsAnswered++;
        loadQuestion();
        optionsEl.classList.remove('no-events');
      }, 2100);
    } else {
      setTimeout(() => {
        document.body.removeChild(clone);
        imgEl.style.visibility = 'visible';
        incorrectAudio.currentTime = 0;
        incorrectAudio.play();
        imgEl.classList.add('shake');
        setTimeout(() => {
          imgEl.classList.remove('shake');
          optionsEl.classList.remove('no-events');
        }, 500);
      }, 2100);
    }
  }

  function endQuiz() {
    quizContainer.classList.add('hidden');
    endContainer.classList.remove('hidden');
    if(playBGM) {
        bgmAudio.pause();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupSettings();
  });

  // Prevent pull-to-refresh
  let startY = 0;
  document.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
  }, { passive: false });

  document.addEventListener('touchmove', (e) => {
    const y = e.touches[0].clientY;
    if (document.scrollingElement.scrollTop === 0 && y > startY) {
      e.preventDefault();
    }
  }, { passive: false });
</script>
</body>
</html>
