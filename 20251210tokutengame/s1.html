<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>てんすうシステム</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: clamp(10px, 2vh, 20px);
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: clamp(16px, 2vw, 24px);
      min-height: 100vh;
      box-sizing: border-box;
    }

    .container {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 100vw;
      gap: clamp(50px, 10vw, 100px);
      flex: 1;
    }

    .party {
      flex: 1;
      text-align: center;
      transition: transform 0.8s;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .party img {
      width: 100%;
      max-width: clamp(150px, 25vw, 200px);
      cursor: pointer;
      margin: 0 auto;
    }

    .bar-container {
      height: clamp(300px, 40vh, 600px);
      width: clamp(60px, 8vw, 120px);
      background: #eee;
      margin: clamp(10px, 2vh, 20px) auto;
      position: relative;
    }

    .bar {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: #4CAF50;
      transition: height 0.9s;
    }

    .votes {
      font-size: clamp(80px, 15vw, 400px);
      font-weight: bold;
      line-height: 1;
    }

    button {
      margin-top: clamp(10px, 2vh, 20px);
      font-size: clamp(16px, 2vw, 24px);
      padding: clamp(8px, 1.5vw, 16px) clamp(16px, 3vw, 32px);
    }

    .party-name {
      font-size: clamp(18px, 3vw, 32px);
      margin-top: clamp(5px, 1vh, 15px);
    }

    .sway-once {
      animation: sway 0.6s ease-in-out 1;
    }

    @keyframes sway {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(-2deg); }
      50% { transform: rotate(2deg); }
      75% { transform: rotate(-1deg); }
      100% { transform: rotate(0deg); }
    }

    .glow {
      box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0.7);
    }
  </style>
</head>
<body>

  <h1></h1>

  <div class="container">
    <div class="party" id="ao">
      <img src="ao.jpg" alt="青チーム" onclick="vote('ao')">
      <div class="party-name">青チーム</div>
      <div class="bar-container">
        <div class="bar" id="bar-ao" style="height: 0%; background: #3498db;"></div>
      </div>
      <div class="votes" id="votes-ao">0 点</div>
    </div>

    <div class="party" id="aka">
      <img src="aka.jpg" alt="赤チーム" onclick="vote('aka')">
      <div class="party-name">赤チーム</div>
      <div class="bar-container">
        <div class="bar" id="bar-aka" style="height: 0%; background: #e74c3c;"></div>
      </div>
      <div class="votes" id="votes-aka">0 点</div>
    </div>
  </div>

  <button onclick="undo()">ひとつ戻る</button>
  <div id="undoArea" style="height: 100px; width: 200px; cursor: pointer;" onclick="undo()"></div>

  <audio id="ao1" src="AO1.MP3" preload="auto"></audio>
  <audio id="aopass" src="AOPASS.MP3" preload="auto"></audio>
  <audio id="aka1" src="AKA1.MP3" preload="auto"></audio>
  <audio id="akapass" src="AKAPASS.MP3" preload="auto"></audio>

  <script>
    const votes = { ao: 0, aka: 0 };
    const history = [];
    let previousWinner = null;
    let canAdd = true;
    let audioUnlocked = false;

    const aoImg = document.querySelector('#ao img');
    const akaImg = document.querySelector('#aka img');

    // 音再生の許可
    function unlockAudio() {
      audioUnlocked = true;
    }
    document.body.addEventListener('mousedown', unlockAudio, { once: true });

    // キーボード入力処理
    document.addEventListener('keydown', function(e) {
      if (!canAdd) return;
      
      let party = null;
      let audioId = '';
      
      // aキーまたはエンターキーでao（青チーム）にAOPASS.MP3
      if (e.key === 'a' || e.key === 'A' || e.key === 'Enter') {
        party = 'ao';
        audioId = 'aopass';
      }
      // ALT+右矢印でao（青チーム）にAOPASS.MP3
      else if (e.altKey && e.key === 'ArrowRight') {
        party = 'ao';
        audioId = 'aopass';
      }
      // ALT+左矢印でao（青チーム）にAO1.MP3  
      else if (e.altKey && e.key === 'ArrowLeft') {
        party = 'ao';
        audioId = 'ao1';
      }
      // ALT+上矢印でaka（赤チーム）にAKAPASS.MP3
      else if (e.altKey && e.key === 'ArrowUp') {
        party = 'aka';
        audioId = 'akapass';
      }
      // ALT+下矢印でaka（赤チーム）にAKA1.MP3
      else if (e.altKey && e.key === 'ArrowDown') {
        party = 'aka';
        audioId = 'aka1';
      }
      
      if (party) {
        votes[party]++;
        history.push(party);
        
        // 音声再生
        const audio = document.getElementById(audioId);
        if (audio) {
          audio.currentTime = 0;
          audio.play().catch(() => {});
        }
        
        updateDisplay();
        canAdd = false;
        setTimeout(() => { canAdd = true; }, 5000);
        e.preventDefault();
      }
    });

    // マウス入力処理
    document.body.addEventListener('mousedown', function(e) {
      // 戻るボタンとその上の領域は除外
      if (e.target.tagName === 'BUTTON' || e.target.id === 'undoArea') return;
      
      let party = null;
      if (e.button === 0) {
        if (e.target === aoImg) party = 'ao';
        else if (e.target === akaImg) party = 'aka';
        else party = 'ao';
      }
      if (e.button === 1) {
        if (e.target === akaImg) party = 'aka';
        else party = 'aka';
        e.preventDefault();
      }
      if (e.button === 2) {
        if (e.target === akaImg) party = 'aka';
        else party = 'aka';
        e.preventDefault();
      }
      if (e.button === 3 || e.button === 4) {
        e.preventDefault();
        return;
      }
      if (party && canAdd) {
        handleVote(party, e);
        canAdd = false;
        setTimeout(() => { canAdd = true; }, 5000);
      }
    });

    // 右クリック禁止
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // 得点処理（マウスクリック用）
    function handleVote(party, e) {
      if (!canAdd) return;
      let audioId = '';
      if (e.button === 0) audioId = 'ao1';
      else if (e.button === 1) audioId = 'aka1';
      else if (e.button === 2) audioId = 'akapass';
      
      if (party === 'ao' || party === 'aka') {
        votes[party]++;
        history.push(party);
        if (audioId) {
          const audio = document.getElementById(audioId);
          audio.currentTime = 0;
          if (!audioUnlocked) {
            audio.play().catch(()=>{});
            audioUnlocked = true;
          } else {
            audio.play();
          }
        }
        updateDisplay();
        canAdd = false;
        setTimeout(() => { canAdd = true; }, 5000);
      }
    }

    function undo() {
      const lastVote = history.pop();
      if (lastVote && votes[lastVote] > 0) {
        votes[lastVote]--;
        updateDisplay();
      }
    }

    function updateDisplay() {
      const total = votes.ao + votes.aka || 1;
      const percentAo = (votes.ao / total) * 100;
      const percentAka = (votes.aka / total) * 100;
      document.getElementById('votes-ao').textContent = `${votes.ao} `;
      document.getElementById('votes-aka').textContent = `${votes.aka} `;
      document.getElementById('bar-ao').style.height = percentAo + '%';
      document.getElementById('bar-aka').style.height = percentAka + '%';
      const aoEl = document.getElementById('ao');
      const akaEl = document.getElementById('aka');
      aoEl.classList.remove('glow', 'sway-once');
      akaEl.classList.remove('glow', 'sway-once');
      let currentWinner = null;
      if (votes.ao > votes.aka) currentWinner = 'ao';
      else if (votes.aka > votes.ao) currentWinner = 'aka';
      if (currentWinner) {
        const winnerEl = document.getElementById(currentWinner);
        winnerEl.classList.add('glow');
        if (currentWinner !== previousWinner) {
          winnerEl.classList.add('sway-once');
          setTimeout(() => {
            winnerEl.classList.remove('sway-once');
          }, 700);
        }
      }
      previousWinner = currentWinner;
    }

    updateDisplay();
  </script>

</body>
</html>
