<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° SVGç‰ˆ</title>
<style>
  body { font-family: sans-serif; text-align: center; }
  svg { user-select: none; }
  .white { fill:#f7f7f2; stroke:#000; }
  .black { fill:#222; }
  .active { fill:#88e !important; }
  .answer { fill:#e33 !important; }
</style>
</head>
<body>

<h1>ğŸ¹ éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>

<button onclick="startQuestion()">â–¶ éŸ³ã‚’å‡ºã™</button>

<p id="status">
  Enter / â†’ ã§åŒã˜éŸ³ã‚’ä½•åº¦ã§ã‚‚å†ç”Ÿã§ãã¾ã™
</p>

<svg id="keyboard" width="980" height="220"></svg>

<script>
const ctx = new (window.AudioContext||window.webkitAudioContext)();
const svg = document.getElementById("keyboard");
const status = document.getElementById("status");

let answer = null;
let answered = false;
let keys = [];

// å‘¨æ³¢æ•°
function freq(n){
  return 440 * Math.pow(2,(n-49)/12);
}

// ãƒ”ã‚¢ãƒé¢¨éŸ³
function piano(n,d=1){
  const g = ctx.createGain();
  g.connect(ctx.destination);
  [1,2,3].forEach(h=>{
    const o = ctx.createOscillator();
    o.type="sine";
    o.frequency.value=freq(n)*h;
    o.connect(g);
    o.start();
    o.stop(ctx.currentTime+d);
  });
  g.gain.setValueAtTime(0.4,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+d);
}

// å‡ºé¡Œé–‹å§‹ï¼ˆæ–°ã—ã„éŸ³ã‚’æ±ºã‚ã‚‹ï¼‰
function startQuestion(){
  clearMarks();
  answer = Math.floor(Math.random()*12)+40; // C4ã€œB4
  answered = false;
  playQuestion();
  status.textContent="ã©ã®éŸ³ï¼Ÿ";
}

// åŒã˜å‡ºé¡ŒéŸ³ã‚’å†ç”Ÿ
function playQuestion(){
  if(answer !== null){
    piano(answer,1.2);
  }
}

// ãƒãƒ¼ã‚¯è§£é™¤
function clearMarks(){
  keys.forEach(k=>{
    if(k) k.classList.remove("active","answer");
  });
}

// åˆ¤å®š
function judge(k, elem){
  if(answered) return; // åˆ¤å®šå¾Œã¯ç„¡åŠ¹

  clearMarks();
  elem.classList.add("active");
  piano(k,0.6);

  answered = true;

  if(k === answer){
    status.textContent="â­• æ­£è§£ï¼ˆæ¬¡ã¯ Enter / â†’ ã§æ–°ã—ã„éŸ³ï¼‰";
  }else{
    keys[answer].classList.add("answer");
    const diff = k - answer;
    status.textContent = `âŒ ${diff>0?"+":""}${diff} åŠéŸ³ã‚ºãƒ¬ï¼ˆæ¬¡ã¯ Enter / â†’ï¼‰`;
  }
}

// SVGéµç›¤ç”Ÿæˆï¼ˆ1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ï¼‰
const whiteOrder = [0,2,4,5,7,9,11];
const blackMap = {1:0.7,3:1.7,6:3.7,8:4.7,10:5.7};

let baseKey = 40; // C4
let x = 0;

// ç™½éµ
whiteOrder.forEach(n=>{
  const k = baseKey+n;
  const r = document.createElementNS("http://www.w3.org/2000/svg","rect");
  r.setAttribute("x",x);
  r.setAttribute("y",0);
  r.setAttribute("width",140);
  r.setAttribute("height",220);
  r.setAttribute("class","white");
  r.onclick=()=>judge(k,r);
  svg.appendChild(r);
  keys[k]=r;
  x+=140;
});

// é»’éµ
Object.keys(blackMap).forEach(n=>{
  const k = baseKey+Number(n);
  const r = document.createElementNS("http://www.w3.org/2000/svg","rect");
  r.setAttribute("x",blackMap[n]*140);
  r.setAttribute("y",0);
  r.setAttribute("width",80);
  r.setAttribute("height",140);
  r.setAttribute("class","black");
  r.onclick=()=>judge(k,r);
  svg.appendChild(r);
  keys[k]=r;
});

// âŒ¨ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
document.addEventListener("keydown",e=>{
  if(e.key==="Enter" || e.key==="ArrowRight"){
    if(answer === null || answered){
      startQuestion();   // æ¬¡ã®å•é¡Œ
    }else{
      playQuestion();    // åŒã˜éŸ³ã‚’å†ç”Ÿ
    }
  }
});
</script>

</body>
</html>
