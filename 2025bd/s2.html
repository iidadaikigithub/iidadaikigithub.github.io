<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>カスタムケーキ</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: url('cake.jpg') no-repeat center center fixed;
      background-size: cover;
      touch-action: none;
    }
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    #decoration-bar {
      position: absolute;
      bottom: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.8);
      z-index: 10;
    }
    #decoration-bar img {
      width: 60px;
      height: auto;
      touch-action: none;
    }
    .draggable {
      position: absolute;
      width: 60px;
      height: auto;
      z-index: 5;
      touch-action: none;
      user-select: none;
    }
    .draggable[data-type="1"] {
      transform: scale(2);
    }
    #oiwai {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      z-index: 10;
      transition: transform 0.3s ease;
    }
    #resetBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 20;
    }
    #musicBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 20;
    }
    #omedetouLayer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      display: none;
      flex-direction: column;
      align-items: center;
    }
    #omedetouLayer img {
      max-width: 80%;
      height: auto;
    }
    #windLayer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('wind.gif') center center no-repeat;
      background-size: contain;
      z-index: 99;
      pointer-events: none;
      display: none;
    }
    #bg-bar {
      position: absolute;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 101;
      background: rgba(255,255,255,0.7);
      padding: 10px 5px;
      border-radius: 10px;
    }
    #bg-bar img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="container">
    <img id="oiwai" src="oiwai.png" width="100">
    <div id="decoration-bar"></div>
    <div id="windLayer"></div>
    <div id="omedetouLayer">
      <img src="omedetou.gif">
      <img src="omedetou.png">
    </div>
    <button id="resetBtn">やり直し</button>
    <button id="musicBtn">♪</button>
  </div>

  <audio id="choko" src="choko.mp3"></audio>
  <audio id="wind" src="wind.mp3"></audio>
  <audio id="omedetou" src="omedetou.mp3"></audio>
  <audio id="m1" src="m1.mp3"></audio>
  <audio id="m2" src="m2.mp3"></audio>
  <audio id="m3" src="m3.mp3"></audio>

  <script>
    const container = document.getElementById("container");
    const choko = document.getElementById("choko");
    const wind = document.getElementById("wind");
    const omedetou = document.getElementById("omedetou");
    const omedetouLayer = document.getElementById("omedetouLayer");
    const windLayer = document.getElementById("windLayer");
    const resetBtn = document.getElementById("resetBtn");
    const musicBtn = document.getElementById("musicBtn");
    const oiwai = document.getElementById("oiwai");
    const musicList = ["m1", "m2", "m3"];
    let musicIndex = 0;
    let oiwaiPressed = false;

    let dragging = false;
    let dragTarget = null;
    let windInterval = null;

    const decorations = [];

    function makeDraggable(el) {
      let offsetX, offsetY;
      let longClickTimer = null;

      const onPointerDown = (e) => {
        e.preventDefault();
        dragging = true;
        dragTarget = el;
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
        el.setPointerCapture(e.pointerId);
      };

      const onPointerMove = (e) => {
        if (!dragging || dragTarget !== el) return;
        el.style.left = `${e.clientX - offsetX}px`;
        el.style.top = `${e.clientY - offsetY}px`;
      };

      const onPointerUp = (e) => {
        dragging = false;
        dragTarget = null;
        el.releasePointerCapture(e.pointerId);

        if (longClickTimer) clearTimeout(longClickTimer);

        if (el.src.includes('2.gif') && !el.fixed) {
          el.src = '1.gif';
        }

        wind.pause();
        wind.currentTime = 0;
        windLayer.style.display = 'none';
      };

      el.addEventListener("pointerdown", onPointerDown);
      el.addEventListener("pointermove", onPointerMove);
      el.addEventListener("pointerup", onPointerUp);
      el.addEventListener("pointercancel", onPointerUp);

      setRandomGifSpeed(el);
    }

    function checkFinish() {
      const all3 = decorations.filter(d => d.dataset.type === '1').every(d => d.src.includes('3.gif'));
      if (all3 && decorations.length > 0) {
        omedetouLayer.style.display = 'flex';
        omedetou.play();
      }
    }

    const bar = document.getElementById("decoration-bar");
    for (let i = 1; i <= 20; i++) {
      const img = document.createElement("img");
      img.src = `${i}.png`;
      img.dataset.id = i;
      img.draggable = false;

      img.addEventListener("pointerdown", e => {
        e.preventDefault();
        const id = img.dataset.id;
        const clone = document.createElement("img");
        clone.src = id === "1" ? "1.gif" : `${id}.png`;
        clone.dataset.type = id;
        clone.classList.add("draggable");
        // 4,5,9以外は3倍、2,3は2倍
        if ([2,3].includes(Number(id))) {
          clone.style.transform = "scale(2)";
        } else if (![4,5,9].includes(Number(id))) {
          clone.style.transform = "scale(3)";
        } else {
          clone.style.transform = "";
        }
        clone.style.left = `${e.clientX - 30}px`;
        clone.style.top = `${e.clientY - 30}px`;
        container.appendChild(clone);
        choko.currentTime = 0;
        choko.play();
        decorations.push(clone);
        makeDraggable(clone);

        const event = new PointerEvent("pointerdown", e);
        clone.dispatchEvent(event);
      });

      bar.appendChild(img);
    }

    // 背景選択バーの追加
    const bgBar = document.createElement('div');
    bgBar.id = 'bg-bar';
    bgBar.style.position = 'absolute';
    bgBar.style.top = '50%';
    bgBar.style.left = '10px';
    bgBar.style.transform = 'translateY(-50%)';
    bgBar.style.display = 'none';
    bgBar.style.flexDirection = 'column';
    bgBar.style.gap = '10px';
    bgBar.style.zIndex = '101';
    bgBar.style.background = 'rgba(255,255,255,0.7)';
    bgBar.style.padding = '10px 5px';
    bgBar.style.borderRadius = '10px';
    container.appendChild(bgBar);

    const bgList = [
      {src: 'h1.png', type: 'h1'},
      {src: 'h2.png', type: 'h2'},
      {src: 'h3.png', type: 'h3'},
      {src: 'h4.png', type: 'h4'},
      {src: 'h5.jpg', type: 'h5'}
    ];

    let currentBg = null;

    bgList.forEach(bg => {
      const icon = document.createElement('img');
      icon.src = bg.src;
      icon.style.width = '50px';
      icon.style.height = '50px';
      icon.style.objectFit = 'cover';
      icon.style.cursor = 'pointer';
      icon.addEventListener('click', () => {
        // 背景画像を設定
        if (currentBg) currentBg.remove();
        const bgImg = document.createElement('img');
        bgImg.src = bg.src;
        bgImg.style.position = 'absolute';
        bgImg.style.top = '0';
        bgImg.style.left = '0';
        bgImg.style.width = '100%';
        bgImg.style.height = '100%';
        bgImg.style.objectFit = 'cover';
        bgImg.style.zIndex = '50';
        bgImg.id = 'customBgImg';
        container.insertBefore(bgImg, omedetouLayer); // omedetouLayerの下に挿入
        currentBg = bgImg;
      });
      bgBar.appendChild(icon);
    });

    oiwai.addEventListener("click", () => {
      oiwai.style.transform = "scale(1.5)";
      setTimeout(() => {
        oiwai.style.transform = "scale(1)";
      }, 300);
      oiwaiPressed = true;
      document.getElementById("decoration-bar").style.display = 'none';
      bgBar.style.display = 'flex';
    });

    resetBtn.addEventListener("click", () => {
      document.querySelectorAll('.draggable').forEach(d => d.remove());
      decorations.length = 0;
      omedetouLayer.style.display = 'none';
      bar.style.display = 'flex';
      oiwaiPressed = false;
      bgBar.style.display = 'none';
      if (currentBg) { currentBg.remove(); currentBg = null; }
    });

    musicBtn.addEventListener("click", () => {
      const m = document.getElementById(musicList[musicIndex]);
      m.currentTime = 0;
      m.play();
      musicIndex = (musicIndex + 1) % musicList.length;
    });

    // タッチ長押しでのコンテキストメニュー（右クリック）を禁止
    container.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // 画面全体クリックでwindエフェクト
    container.addEventListener("pointerdown", function(e) {
      if (!oiwaiPressed) return;
      // 1.gif上なら何もしない
      if (e.target.tagName === 'IMG' && e.target.src.includes('1.gif')) return;

      // wind再生・windLayer表示
      wind.currentTime = 0;
      wind.play();
      windLayer.style.display = 'block';

      // 画面上の1.gifを2.gifに
      const ones = Array.from(document.querySelectorAll('img.draggable[data-type="1"]'));
      ones.forEach(img => {
        if (!img.fixed && img.src.includes('1.gif')) img.src = '2.gif';
      });

      // 2.gif→3.gifのタイミングを個別に
      const twos = Array.from(document.querySelectorAll('img.draggable[data-type="1"]')).filter(img => img.src.includes('2.gif') && !img.fixed);
      twos.forEach((img, idx) => {
        if (!img._windTimeout) {
          // 1.5〜3秒のランダム時間＋順番ごとに1秒ずつ遅延
          const delay = 1500 + Math.random() * 1500 + idx * 1000;
          img._windTimeout = setTimeout(() => {
            if (!img.fixed && img.src.includes('2.gif')) {
              img.src = '3.gif';
              img.fixed = true;
              checkFinish();
            }
            img._windTimeout = null;
          }, delay);
        }
      });
    });

    // 1.gif,2.gif,3.gifのアニメーション速度をランダムにする（点滅は不要なので削除）
    function setRandomGifSpeed(img) {
      // 何もしない
    }

    function stopWindEffect() {
      wind.pause();
      wind.currentTime = 0;
      windLayer.style.display = 'none';
      // 2.gifを1.gifに戻す（fixedでないもののみ）
      const twos = Array.from(document.querySelectorAll('img.draggable[data-type="1"]'));
      twos.forEach(img => {
        if (!img.fixed && img.src.includes('2.gif')) img.src = '1.gif';
        if (img._windTimeout) { clearTimeout(img._windTimeout); img._windTimeout = null; }
      });
    }

    // pointerup, pointerleaveでwindエフェクト停止
    container.addEventListener("pointerup", function(e) {
      stopWindEffect();
    });
    container.addEventListener("pointerleave", function(e) {
      stopWindEffect();
    });
  </script>
</body>
</html>
