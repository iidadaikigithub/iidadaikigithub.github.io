<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>13</title>
<style>
  html, body {
    margin: 0; padding: 0;
    width: 100vw; height: 100vh;
    overflow: hidden;
    background: #fff;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    touch-action: manipulation;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100vw; height: 100vh;
    background: #fff;
    transition: opacity 0.5s ease-out;
  }
  img.page-image {
    width: 100vw;
    height: 100vh;
    object-fit: contain;
    user-select: none;
    pointer-events: none;
  }
  canvas#drawCanvas {
    position: absolute;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    touch-action: none;
    display: none;
    z-index: 5;
  }
  #rocket {
    position: absolute;
    width: 10vw;
    height: auto;
    user-select: none;
    pointer-events: none;
    display: none;
  }
  .nav, .action-btn, #trajectoryBtn, #autoBtn {
    position: absolute;
    font-size: 18px;
    padding: 8px 14px;
    background: rgba(255,255,255,0.85);
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    z-index: 20;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    transition: transform 0.1s ease;
  }
  .nav:active, .action-btn:active, #trajectoryBtn:active, #autoBtn:active {
    transform: scale(1.1);
  }
  #prev { top: 10px; left: 10px; }
  #next {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 50px;
    height: 50px;
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    font-size: 24px;
    z-index: 1000;
  }
  #trajectoryBtn { top: 10px; left: 40%; transform: translateX(-50%); }
  /* #autoBtn の個別サイズ指定を削除。位置のみ下部右側に調整 */
  #autoBtn {
    bottom: 20px;
    left: calc(50% + 80px);
    top: auto;
    right: auto;
    transform: none;
  }
  #action { bottom: 20px; left: 50%; transform: translateX(-50%); }
  /* #speedControl 削除 */
</style>
</head>
<body oncontextmenu="return false" onselectstart="return false" ondragstart="return false" onmousedown="if(event.button!==0)event.preventDefault();">
  <div id="container">
    <img src="13.jpg" alt="背景" class="page-image" />
    <canvas id="drawCanvas"></canvas>
    <img id="rocket" src="13-2.png" alt="ロケット" />
  </div>
  <div id="prev" class="nav">← 戻る</div>
  <div id="next" class="nav">→ 次へ</div>
  <div id="trajectoryBtn" class="action-btn">軌道ボタン</div>
  <div id="action" class="action-btn" style="display:none;">アクション</div>
  <div id="autoBtn" class="action-btn" style="display:none;">オートモード</div>

<script>
  const trajectoryBtn = document.getElementById('trajectoryBtn');
  const autoBtn = document.getElementById('autoBtn');
  const actionBtn = document.getElementById('action');
  const canvas = document.getElementById('drawCanvas');
  const ctx = canvas.getContext('2d');
  const rocket = document.getElementById('rocket');
  // スピードバー削除
  // スピードは0.05固定
  const container = document.getElementById('container');
  const nextBtn = document.getElementById('next');
  const prevBtn = document.getElementById('prev');

  let drawing = false;
  let path = [];
  let animationPlaying = false;
  let animationIndex = 0;
  let animationReqId = null;
  let rightClickPressed = false;
  let autoMode = false;

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function drawLine(x, y) {
    if (path.length === 0) {
      ctx.beginPath();
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 4;
      ctx.lineCap = 'round';
      ctx.stroke();
    }
    path.push({x, y});
  }

  trajectoryBtn.addEventListener('click', () => {
  trajectoryBtn.style.display = 'none';
  rocket.style.display = 'block';
  canvas.style.display = 'block';
  actionBtn.style.display = 'block';
  autoBtn.style.display = 'block';

    // ロケットを画面左下に初期配置
    rocket.style.left = '10px';
    rocket.style.top = (window.innerHeight - rocket.clientHeight - 10) + 'px';
    rocket.style.transform = 'translate(0%, -50%) rotate(-135deg)';
  });

  canvas.addEventListener('mousedown', (e) => {
    if(animationPlaying) return;
    if(e.button === 0) {
      drawing = true;
      path = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawLine(e.offsetX, e.offsetY);
    }
  });
  canvas.addEventListener('mousemove', (e) => {
    if(drawing && !animationPlaying) {
      drawLine(e.offsetX, e.offsetY);
    }
  });
  canvas.addEventListener('mouseup', (e) => {
    if(e.button === 0) drawing = false;
  });
  canvas.addEventListener('mouseleave', () => { drawing = false; });

  canvas.addEventListener('touchstart', (e) => {
    if(animationPlaying) return;
    e.preventDefault();
    drawing = true;
    path = [];
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const t = e.touches[0];
    drawLine(t.clientX, t.clientY);
  }, {passive:false});
  canvas.addEventListener('touchmove', (e) => {
    if(drawing && !animationPlaying) {
      e.preventDefault();
      const t = e.touches[0];
      drawLine(t.clientX, t.clientY);
    }
  }, {passive:false});
  canvas.addEventListener('touchend', (e) => {
    drawing = false;
  });

  document.body.addEventListener('mousedown', (e) => {
    if (e.button === 2) {
      rightClickPressed = true;
      if(animationPlaying && !animationReqId && !autoMode) {
        animateStep();
      }
      e.preventDefault();
    }
  });
  document.body.addEventListener('mouseup', (e) => {
    if (e.button === 2) {
      rightClickPressed = false;
      e.preventDefault();
    }
  });
  document.body.addEventListener('contextmenu', (e) => e.preventDefault());

  function animateStep() {
    if(animationIndex >= path.length) {
      cancelAnimationFrame(animationReqId);
      container.style.opacity = 0;
      setTimeout(() => location.href = '14.html', 500);
      return;
    }
    if(autoMode || rightClickPressed) {
      // スピードは0.05固定
      for (let i = 0; i < 0.05 && animationIndex < path.length; i++) {
        const curr = path[animationIndex];
        rocket.style.left = (curr.x) + 'px';
        rocket.style.top = (curr.y) + 'px';

        if(animationIndex + 1 < path.length) {
          const next = path[animationIndex + 1];
          const dx = next.x - curr.x;
          const dy = next.y - curr.y;
          const angleRad = Math.atan2(dy, dx);
          const angleDeg = angleRad * 180 / Math.PI;
          rocket.style.transform = `translate(-50%, -50%) rotate(${angleDeg - 45 + 180}deg)`;
        }
        animationIndex++;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      for(let i = animationIndex; i < path.length; i++) {
        if(i === animationIndex) {
          ctx.moveTo(path[i].x, path[i].y);
        } else {
          ctx.lineTo(path[i].x, path[i].y);
        }
      }
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 4;
      ctx.lineCap = 'round';
      ctx.stroke();
    }
    animationReqId = requestAnimationFrame(animateStep);
  }

  actionBtn.addEventListener('click', () => {
    if(path.length === 0) return;
    path.reverse(); // 逆順にする
    animationPlaying = true;
    animationIndex = 0;
    animateStep();
  });

  autoBtn.addEventListener('click', () => {
    if(!animationPlaying || path.length === 0) return;
    autoMode = !autoMode;
    autoBtn.textContent = autoMode ? 'オートモード: ON' : 'オートモード: OFF';
    if(autoMode && !animationReqId) {
      animateStep();
    }
  });

  function handleBodyClick(e) {
    if (!e.target.closest('.action-btn') && !e.target.closest('.nav') && !e.target.closest('canvas')) {
      if (trajectoryBtn.style.display !== 'none') {
        trajectoryBtn.click();
      } else if (actionBtn.style.display !== 'none') {
        actionBtn.click();
      }
    }
  }

  document.body.addEventListener('click', handleBodyClick);
  document.body.addEventListener('touchstart', handleBodyClick);

  nextBtn.addEventListener('click', () => {
    container.style.opacity = 0;
    setTimeout(() => location.href = '14.html', 500);
  });

  prevBtn.addEventListener('click', () => {
    container.style.opacity = 0;
    setTimeout(() => location.href = '12.html', 500);
  });

  window.addEventListener('load', () => {
    container.style.opacity = 1;
  });
</script>
</body>
</html>
